name: Build Android APK AutomÃ¡tico

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Permite rodar manualmente

jobs:
  build-android-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›ï¸ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js 22
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: |
        npm ci || npm install
        npm install -g @capacitor/cli
        
    - name: ğŸ—ï¸ Criar pasta dist (seu site web)
      run: |
        # Cria diretÃ³rio dist
        mkdir -p dist
        
        # Copia arquivos principais
        cp index.html dist/ || true
        cp *.css dist/ 2>/dev/null || true
        cp *.js dist/ 2>/dev/null || true
        
        # Copia assets se existirem
        if [ -d "assets" ]; then
          cp -r assets dist/ || true
        fi
        
        if [ -d "public" ]; then
          cp -r public dist/ || true
        fi
        
        echo "âœ… Pasta dist criada com sucesso"
        ls -la dist/
        
    - name: âš™ï¸ Configurar Capacitor
      run: |
        # Usa configuraÃ§Ã£o existente
        if [ -f "capacitor.config.ts" ] || [ -f "capacitor.config.json" ]; then
          echo "âœ… ConfiguraÃ§Ã£o do Capacitor encontrada"
          npx cap add android
          npx cap sync android
        else
          echo "âš ï¸ Criando configuraÃ§Ã£o bÃ¡sica..."
          npx cap init --web-dir dist --package-id com.narcisomanjate.superagentemng --app-name "Super Agente MNG" --yes
          npx cap add android
          npx cap sync android
        fi
        
    - name: ğŸ­ Build APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug
        
    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: super-agente-apk
        path: android/app/build/outputs/apk/debug/*.apk
        retention-days: 7
        
    - name: ğŸ‰ Criar Release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: "Super Agente MNG APK"
        body: |
          ğŸ“± **APK gerado automaticamente**
          
          **InstalaÃ§Ã£o:**
          1. Baixe o arquivo `.apk`
          2. Transfira para seu celular Android
          3. Permita "Fontes desconhecidas"
          4. Instale e teste!
          
          **Build Info:**
          - Commit: ${{ github.sha }}
          - Data: ${{ github.event.head_commit.timestamp }}
        files: android/app/build/outputs/apk/debug/*.apk