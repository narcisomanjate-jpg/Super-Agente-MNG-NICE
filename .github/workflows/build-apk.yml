name: Build Android APK AutomÃ¡tico

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ›Žï¸ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js 18 (mais compatÃ­vel)
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ðŸ“¦ Instalar Capacitor global
      run: |
        npm install -g @capacitor/cli @capacitor/core @capacitor/android
        
    - name: ðŸ—ï¸ Preparar projeto web
      run: |
        # Cria estrutura mÃ­nima
        mkdir -p dist
        
        # Copia index.html e assets
        cp index.html dist/
        
        if [ -d "assets" ]; then
          cp -r assets/ dist/
        fi
        
        if [ -d "public" ]; then
          cp -r public/ dist/
        fi
        
        echo "ðŸ“ ConteÃºdo da pasta dist:"
        ls -la dist/
        
    - name: âš™ï¸ Inicializar Capacitor do ZERO
      run: |
        # Remove configs antigas se existirem
        rm -rf android ios
        
        # Cria capacitor.config.json mÃ­nimo
        echo '{
          "appId": "com.narcisomanjate.superagentemng",
          "appName": "Super Agente MNG",
          "webDir": "dist",
          "bundledWebRuntime": false,
          "plugins": {
            "SplashScreen": {
              "launchShowDuration": 2200,
              "launchAutoHide": true,
              "backgroundColor": "#667eea",
              "androidScaleType": "CENTER_CROP",
              "splashFullScreen": true
            }
          }
        }' > capacitor.config.json
        
        # Inicializa Capacitor SEM interaÃ§Ã£o
        npx cap init --web-dir dist \
          --package-id com.narcisomanjate.superagentemng \
          --app-name "Super Agente MNG" \
          --yes
        
        # Adiciona plataforma Android
        npx cap add android --yes
        
        # Sincroniza
        npx cap sync android
        
        echo "âœ… Capacitor Android configurado"
        
    - name: ðŸ­ Build APK
      run: |
        cd android
        chmod +x gradlew
        
        # Configura Java 17 explicitamente
        echo "org.gradle.java.home=/usr/lib/jvm/temurin-17-jdk-amd64" > gradle.properties
        
        ./gradlew assembleDebug --no-daemon
        
    - name: ðŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: super-agente-apk
        path: android/app/build/outputs/apk/debug/*.apk
        retention-days: 7
        
    - name: ðŸŽ‰ Criar Release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: apk-v${{ github.run_number }}
        name: "Super Agente MNG APK"
        body: |
          ðŸ“± **APK gerado automaticamente**
          
          **InstalaÃ§Ã£o:**
          1. Baixe o arquivo `.apk`
          2. Transfira para seu celular Android
          3. Permita "Fontes desconhecidas"
          4. Instale e teste!
          
          **Build #${{ github.run_number }}**
          - Commit: ${{ github.sha }}
          - Data: ${{ github.event.head_commit.timestamp }}
        files: android/app/build/outputs/apk/debug/*.apkname: Build Android APK AutomÃ¡tico

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-android-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ›Žï¸ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js 18 (mais compatÃ­vel)
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: â˜• Setup Java 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ðŸ“¦ Instalar Capacitor global
      run: |
        npm install -g @capacitor/cli @capacitor/core @capacitor/android
        
    - name: ðŸ—ï¸ Preparar projeto web
      run: |
        # Cria estrutura mÃ­nima
        mkdir -p dist
        
        # Copia index.html e assets
        cp index.html dist/
        
        if [ -d "assets" ]; then
          cp -r assets/ dist/
        fi
        
        if [ -d "public" ]; then
          cp -r public/ dist/
        fi
        
        echo "ðŸ“ ConteÃºdo da pasta dist:"
        ls -la dist/
        
    - name: âš™ï¸ Inicializar Capacitor do ZERO
      run: |
        # Remove configs antigas se existirem
        rm -rf android ios
        
        # Cria capacitor.config.json mÃ­nimo
        echo '{
          "appId": "com.narcisomanjate.superagentemng",
          "appName": "Super Agente MNG",
          "webDir": "dist",
          "bundledWebRuntime": false,
          "plugins": {
            "SplashScreen": {
              "launchShowDuration": 2200,
              "launchAutoHide": true,
              "backgroundColor": "#667eea",
              "androidScaleType": "CENTER_CROP",
              "splashFullScreen": true
            }
          }
        }' > capacitor.config.json
        
        # Inicializa Capacitor SEM interaÃ§Ã£o
        npx cap init --web-dir dist \
          --package-id com.narcisomanjate.superagentemng \
          --app-name "Super Agente MNG" \
          --yes
        
        # Adiciona plataforma Android
        npx cap add android --yes
        
        # Sincroniza
        npx cap sync android
        
        echo "âœ… Capacitor Android configurado"
        
    - name: ðŸ­ Build APK
      run: |
        cd android
        chmod +x gradlew
        
        # Configura Java 17 explicitamente
        echo "org.gradle.java.home=/usr/lib/jvm/temurin-17-jdk-amd64" > gradle.properties
        
        ./gradlew assembleDebug --no-daemon
        
    - name: ðŸ“¤ Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: super-agente-apk
        path: android/app/build/outputs/apk/debug/*.apk
        retention-days: 7
        
    - name: ðŸŽ‰ Criar Release
      uses: softprops/action-gh-release@v1
      if: success()
      with:
        tag_name: apk-v${{ github.run_number }}
        name: "Super Agente MNG APK"
        body: |
          ðŸ“± **APK gerado automaticamente**
          
          **InstalaÃ§Ã£o:**
          1. Baixe o arquivo `.apk`
          2. Transfira para seu celular Android
          3. Permita "Fontes desconhecidas"
          4. Instale e teste!
          
          **Build #${{ github.run_number }}**
          - Commit: ${{ github.sha }}
          - Data: ${{ github.event.head_commit.timestamp }}
        files: android/app/build/outputs/apk/debug/*.apk